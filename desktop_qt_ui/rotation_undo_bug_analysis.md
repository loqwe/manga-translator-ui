### **现状、成因及未来计划分析**

#### **一、目前的现状**

当前应用的核心问题是：在编辑器中，对一个文本框进行**旋转**操作，然后执行**撤销**，会导致该文本框的角度显示不正确（发生大幅度偏移）。

此问题由一个更深层次的Bug导致，并且在调试过程中，我们还发现了另一个相关的视觉问题：文本框的框体和内部文字的旋转方向标准不统一，可能导致视觉上不一致。

#### **二、成因分析**

经过反复的测试和代码回滚，根本原因被定位在 `RegionTextItem` (图形项) 的内部设计上，它存在两个相互关联的、致命的缺陷：

1.  **核心缺陷：数据状态污染**
    *   当用户完成一次几何编辑（特别是旋转）后，`RegionTextItem` 会将其最终在屏幕上显示的、**已经被旋转过**的顶点坐标，直接写回并覆盖了数据模型中本应存放**原始、未旋转**坐标的 `lines` 字段。
    *   这个操作从根本上“污染”了数据模型。当这个被污染的数据被存入历史记录，并在“撤销”时被恢复，就为后续的错误埋下了伏笔。

2.  **衍生缺陷：标准不统一 和 逻辑冲突**
    *   **旋转标准冲突**：代码中混用了两种相反的旋转标准。底层几何计算函数使用“逆时针为正”，而Qt界面库使用“顺时针为正”。这导致了“框体和文字角度相反”的视觉Bug。
    *   **初始化逻辑冲突**：`RegionTextItem` 在被重新创建时（例如“撤销”操作后），会忽略数据中已存的、正确的 `center`（中心点），而是自己重新计算一个有偏差的中心点。

**“撤销后角度错误”的完整过程**：
当执行“撤销”时，程序加载了干净的旧数据来重新创建文本框。但有缺陷的初始化代码使用了自己计算的、有偏差的中心点去应用旋转，导致了您看到的巨大角度偏移。

#### **三、未来的计划**

鉴于此问题的复杂性和我之前的多次失败，最有效的推进方式是直接执行用户（您）指定的代码修改。如果需要我来主导修复，我建议进行一次小规模重构，一劳永逸地解决此问题。

1.  **首选方案：等待您的明确指令**
    *   我将暂停所有主动的修改，等待您提供最直接、最关键的修复指令。

2.  **备选方案（如果需要我来修复）**
    *   **第一步：修复数据污染**：修改 `RegionTextItem` 的 `mouseReleaseEvent` 方法，确保在编辑结束后，传递给数据模型的是“干净”的数据（即，`lines` 存放未旋转的坐标，`angle` 和 `center` 作为独立的变换参数）。
    *   **第二步：统一旋转标准**：在 `RegionTextItem` 和 `GraphicsView` 中，统一使用“逆时针为正”的标准。在必须调用Qt的旋转函数时，手动将角度值取反 (`-angle`)。
    *   **第三步：修复初始化逻辑**：修改 `RegionTextItem` 的 `__init__` 方法，强制它在创建时必须优先使用数据中已有的 `center`，而不是自己重新计算。

  首先是绿框和白框的逻辑。绿框代表的是程序根据您的译文和字体大小自动计算出的文本最终会占据的渲染区域。它是一
  个结果的指示，您不能直接拖动它。当您选中一个文本区域时，会出现一个比绿框更大的白框，这个白框带有可以拖动的
  交互点。它的作用是让您可以手动调整文本的渲染边界，当您觉得程序自动计算的绿框不合适时，可以通过拖动这个白框
  来强制指定文本的渲染范围。


  接下来是编辑形状的逻辑。您有两种方式编辑形状。第一种是编辑最原始的文本检测区域，也就是您看到的蓝色或黄色的
  框。当您选中一个区域时，这个框会变成蓝色，并显示出蓝色的顶点和红色的旋转点。拖动这些点可以直接改变这个原始
  多边形的形状和角度。第二种方式就是编辑我们刚才提到的白色外框，通过拖动它的黄色角点或橙色边缘点，可以改变最
  终文本的渲染边界，这是一种手动的微调。


  然后是添加文本框的逻辑。这个过程是，您在画布上点击鼠标右键，从弹出的菜单里选择添加文本框。这时，程序会进入
  一个特殊的绘制模式。您在画布上按住鼠标左键并拖动，就能画出一个矩形。当您松开鼠标时，程序就会在您画的这个位
  置和大小创建一个全新的，带有默认文字和样式的文本框。


  关于右键菜单的逻辑。当您在画布上点击鼠标右键时，程序会立刻在您鼠标的位置弹出一个快捷菜单。这个菜单里包含了
  比如复制，粘贴，或者添加新文本框等常用操作。程序知道您右键点击时鼠标下方有什么，所以这个菜单的内容可能会根
  据您是否选中了文本框而变化。


  最后是复制粘贴的逻辑。当您对一个选中的文本框执行复制操作时，无论是通过右键菜单还是快捷键，程序会把这个文本
  框的所有信息，包括它的文字内容，字体大小，颜色，形状，角度等等，都完整地保存到一个临时的内存剪贴板里。当您
  执行粘贴操作时，程序会从剪贴板里读出这些存好的信息，然后创建一个一模一样的新文本框，并把它放置在您当前鼠标
  指针所在的位置。还有一个特殊功能是粘贴样式，它只会复制源文本框的外观和形状风格，并应用到另一个已有的文本框
  上，但不会改变那个文本框原来的文字。