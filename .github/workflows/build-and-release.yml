name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.3.0)'
        required: true
        default: '1.3.0'

jobs:
  build-cpu:
    runs-on: windows-latest
    name: Build CPU Version
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_cpu.txt
        pip install pyinstaller
    
    - name: Build CPU version
      run: |
        python build_packages.py
        echo "2" | python build_packages.py
    
    - name: Upload CPU artifacts
      uses: actions/upload-artifact@v3
      with:
        name: manga-translator-cpu
        path: dist/manga-translator-cpu-final/
    
    - name: Create CPU update package
      run: |
        python update_manager.py --build-updates
    
    - name: Upload CPU update package
      uses: actions/upload-artifact@v3
      with:
        name: cpu-updates
        path: updates/cpu/

  build-gpu:
    runs-on: windows-latest
    name: Build GPU Version
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install CUDA dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
        pip install -r requirements_gpu.txt
        pip install pyinstaller
    
    - name: Build GPU version
      run: |
        python build_packages.py
        echo "1" | python build_packages.py
    
    - name: Upload GPU artifacts
      uses: actions/upload-artifact@v3
      with:
        name: manga-translator-gpu
        path: dist/manga-translator-gpu-cuda118/
    
    - name: Create GPU update package
      run: |
        python update_manager.py --build-updates
    
    - name: Upload GPU update package
      uses: actions/upload-artifact@v3
      with:
        name: gpu-updates
        path: updates/gpu/

  release:
    needs: [build-cpu, build-gpu]
    runs-on: ubuntu-latest
    name: Create Release
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download CPU artifacts
      uses: actions/download-artifact@v3
      with:
        name: manga-translator-cpu
        path: dist/manga-translator-cpu/
    
    - name: Download GPU artifacts
      uses: actions/download-artifact@v3
      with:
        name: manga-translator-gpu
        path: dist/manga-translator-gpu/
    
    - name: Download CPU updates
      uses: actions/download-artifact@v3
      with:
        name: cpu-updates
        path: updates/cpu/
    
    - name: Download GPU updates
      uses: actions/download-artifact@v3
      with:
        name: gpu-updates
        path: updates/gpu/
    
    - name: Create release archives
      run: |
        cd dist
        zip -r manga-translator-cpu-v${{ github.ref_name }}.zip manga-translator-cpu/
        zip -r manga-translator-gpu-v${{ github.ref_name }}.zip manga-translator-gpu/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## Manga Translator UI ${{ github.ref_name }}
          
          ### 下载链接
          - [CPU版本](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/manga-translator-cpu-v${{ github.ref_name }}.zip)
          - [GPU版本](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/manga-translator-gpu-v${{ github.ref_name }}.zip)
          
          ### 更新内容
          - 添加PyUpdater自动更新功能
          - 优化GPU和CPU版本构建流程
          - 修复翻译界面显示问题
          - 改进错误处理机制
          
          ### 系统要求
          - Windows 10/11
          - 8GB+ RAM
          - GPU版本需要NVIDIA显卡和CUDA支持
        files: |
          dist/manga-translator-cpu-v${{ github.ref_name }}.zip
          dist/manga-translator-gpu-v${{ github.ref_name }}.zip
        draft: false
        prerelease: false
    
    - name: Upload update files
      run: |
        # 这里可以添加将更新文件上传到GitHub Pages或其他CDN的逻辑
        echo "Update files are ready in updates/ directory"
