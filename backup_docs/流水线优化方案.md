# æµæ°´çº¿å¹¶è¡Œæ¨¡å¼ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ ä¼˜åŒ–è®¾è®¡

### åŸè®¾è®¡é—®é¢˜
```
çº¿1: æ£€æµ‹+OCR+è¶…åˆ† (æ…¢ï¼Œè¶…åˆ†å ç”¨å¤§é‡æ—¶é—´)
çº¿2: ç¿»è¯‘
çº¿3: Inpainting+æ¸²æŸ“
```

### æ–°ä¼˜åŒ–è®¾è®¡ âœ…
```
çº¿1: æ£€æµ‹+OCR (æœ€è½»å¿«ï¼Œå¿«é€Ÿå®Œæˆ)
çº¿2: Inpainting+ç¿»è¯‘ (æ™ºèƒ½å¹¶è¡Œï¼ŒGPUå’ŒAPIåŒæ—¶å·¥ä½œ)
çº¿3: æ¸²æŸ“+è¶…åˆ† (æœ€ç»ˆåˆæˆ)
```

## ğŸ“‹ å…·ä½“ä¿®æ”¹ä½ç½®

### æ–‡ä»¶ï¼š`d:\æ¼«ç”»\1\manga_translator\manga_translator.py`

---

### ä¿®æ”¹1ï¼šä¼˜åŒ–çº¿1ï¼ˆé¢„å¤„ç†å·¥ä½œå™¨ï¼‰

**ä½ç½®**ï¼šç¬¬2429-2457è¡Œ

**åŸä»£ç **ï¼š
```python
async def preprocess_worker():
    """é¢„å¤„ç†å·¥ä½œå™¨ï¼šæ‰§è¡Œæ£€æµ‹ã€OCRç­‰æ­¥éª¤1-4"""
    for idx, (image, config) in enumerate(images_with_configs):
        try:
            logger.info(f"[Pipeline-Preprocess] ğŸ” Processing image {idx+1}/{total_images}")
            self._set_image_context(config, image)
            
            from .utils.generic import get_image_md5
            image_md5 = get_image_md5(image)
            self._save_current_image_context(image_md5)
            
            ctx = await self._translate_until_translation(image, config)
            if hasattr(image, 'name'):
                ctx.image_name = image.name
            
            await preprocess_queue.put((idx, ctx, config))
            logger.info(f"[Pipeline-Preprocess] âœ… Image {idx+1} ready for translation")
```

**ä¿®æ”¹ä¸º**ï¼š
```python
async def preprocess_worker():
    """çº¿1ï¼šä»…æ‰§è¡Œæ£€æµ‹+OCRï¼ˆæœ€è½»å¿«ï¼‰"""
    for idx, (image, config) in enumerate(images_with_configs):
        try:
            logger.info(f"[Pipeline-Line1-Detection] ğŸ” Detecting & OCR image {idx+1}/{total_images}")
            self._set_image_context(config, image)
            
            from .utils.generic import get_image_md5
            image_md5 = get_image_md5(image)
            self._save_current_image_context(image_md5)
            
            # âœ… å…³é”®ä¼˜åŒ–ï¼šä¸´æ—¶ç¦ç”¨è¶…åˆ†ï¼Œè®©çº¿1åªåšæ£€æµ‹+OCR
            original_upscale_ratio = config.upscale.upscale_ratio
            config.upscale.upscale_ratio = None
            
            ctx = await self._translate_until_translation(image, config)
            
            # æ¢å¤é…ç½®å¹¶ä¿å­˜ä¾›åç»­ä½¿ç”¨
            config.upscale.upscale_ratio = original_upscale_ratio
            ctx.pipeline_upscale_ratio = original_upscale_ratio  # ä¼ é€’ç»™çº¿3ä½¿ç”¨
            
            if hasattr(image, 'name'):
                ctx.image_name = image.name
            
            await preprocess_queue.put((idx, ctx, config))
            logger.info(f"[Pipeline-Line1-Detection] âœ… Image {idx+1} detection & OCR completed")
```

---

### ä¿®æ”¹2ï¼šé‡æ„çº¿2ï¼ˆç¿»è¯‘+æ“¦é™¤å¹¶è¡Œå·¥ä½œå™¨ï¼‰

**ä½ç½®**ï¼šç¬¬2459-2503è¡Œ

**åŸä»£ç **ï¼š
```python
async def translate_worker():
    """ç¿»è¯‘å·¥ä½œå™¨ï¼šæ‰§è¡Œç¿»è¯‘æ­¥éª¤5"""
    while True:
        item = await preprocess_queue.get()
        if item is None:
            await translate_queue.put(None)
            break
        
        idx, ctx, config = item
        try:
            logger.info(f"[Pipeline-Translate] ğŸŒ Translating image {idx+1}/{total_images}")
            
            if ctx.text_regions:
                all_texts = [region.text for region in ctx.text_regions]
                page_index = len(self.all_page_translations) + idx
                batch_original_texts = [{'original_texts': all_texts}]
                ctx = await self._load_and_prepare_prompts(config, ctx)
                
                translated_texts = await self._batch_translate_texts(
                    all_texts, config, ctx, [ctx],
                    page_index=page_index, batch_index=0,
                    batch_original_texts=batch_original_texts
                )
                
                for region, translation in zip(ctx.text_regions, translated_texts):
                    region.translation = translation
                    region.target_lang = config.translator.target_lang
                    region._alignment = config.render.alignment
                    region._direction = config.render.direction
                
                ctx.text_regions = await self._apply_post_translation_processing(ctx, config)
                page_trans = {r.text: r.translation for r in ctx.text_regions if r.translation}
                self.all_page_translations.append(page_trans)
                
                logger.info(f"[Pipeline-Translate] âœ… Image {idx+1} translation completed")
            else:
                logger.info(f"[Pipeline-Translate] âš ï¸ Image {idx+1} has no text regions")
            
            await translate_queue.put((idx, ctx, config))
```

**ä¿®æ”¹ä¸º**ï¼š
```python
async def inpaint_translate_worker():
    """çº¿2ï¼šInpainting + ç¿»è¯‘ï¼ˆæ™ºèƒ½å¹¶è¡Œï¼‰"""
    while True:
        item = await preprocess_queue.get()
        if item is None:
            await translate_queue.put(None)
            break
        
        idx, ctx, config = item
        try:
            logger.info(f"[Pipeline-Line2-Parallel] ğŸ”„ Inpainting & Translating image {idx+1}/{total_images}")
            
            if ctx.text_regions:
                # âœ… å…³é”®ä¼˜åŒ–ï¼šInpaintingå’Œç¿»è¯‘å¹¶è¡Œæ‰§è¡Œ
                
                # åˆ›å»ºä¸¤ä¸ªå¹¶è¡Œä»»åŠ¡
                async def do_inpainting():
                    """æ‰§è¡ŒInpaintingï¼ˆGPUä»»åŠ¡ï¼‰"""
                    logger.info(f"[Pipeline-Line2-GPU] ğŸ–Œï¸ Inpainting image {idx+1}")
                    # Mask generation
                    if ctx.mask is None and ctx.mask_raw is not None:
                        await self._report_progress('mask-generation')
                        ctx.mask = await self._run_mask_refinement(config, ctx)
                    
                    # Inpainting
                    await self._report_progress('inpainting')
                    ctx.img_inpainted = await self._run_inpainting(config, ctx)
                    
                    if self.verbose:
                        imwrite_unicode(self._result_path('inpainted.png'), 
                                      cv2.cvtColor(ctx.img_inpainted, cv2.COLOR_RGB2BGR), logger)
                    
                    if hasattr(ctx, 'image_name') and ctx.image_name:
                        self._save_inpainted_image(ctx.image_name, ctx.img_inpainted)
                    
                    logger.info(f"[Pipeline-Line2-GPU] âœ… Inpainting completed for image {idx+1}")
                
                async def do_translation():
                    """æ‰§è¡Œç¿»è¯‘ï¼ˆAPI/CPUä»»åŠ¡ï¼‰"""
                    logger.info(f"[Pipeline-Line2-API] ğŸŒ Translating image {idx+1}")
                    all_texts = [region.text for region in ctx.text_regions]
                    page_index = len(self.all_page_translations) + idx
                    batch_original_texts = [{'original_texts': all_texts}]
                    
                    temp_ctx = await self._load_and_prepare_prompts(config, ctx)
                    
                    translated_texts = await self._batch_translate_texts(
                        all_texts, config, temp_ctx, [temp_ctx],
                        page_index=page_index, batch_index=0,
                        batch_original_texts=batch_original_texts
                    )
                    
                    for region, translation in zip(ctx.text_regions, translated_texts):
                        region.translation = translation
                        region.target_lang = config.translator.target_lang
                        region._alignment = config.render.alignment
                        region._direction = config.render.direction
                    
                    ctx.text_regions = await self._apply_post_translation_processing(ctx, config)
                    page_trans = {r.text: r.translation for r in ctx.text_regions if r.translation}
                    self.all_page_translations.append(page_trans)
                    
                    logger.info(f"[Pipeline-Line2-API] âœ… Translation completed for image {idx+1}")
                
                # âœ… å¹¶è¡Œæ‰§è¡ŒInpaintingå’Œç¿»è¯‘
                await asyncio.gather(do_inpainting(), do_translation())
                
                logger.info(f"[Pipeline-Line2-Parallel] âœ… Image {idx+1} inpainting & translation completed")
            else:
                logger.info(f"[Pipeline-Line2-Parallel] âš ï¸ Image {idx+1} has no text regions")
            
            await translate_queue.put((idx, ctx, config))
```

---

### ä¿®æ”¹3ï¼šä¼˜åŒ–çº¿3ï¼ˆæ¸²æŸ“+è¶…åˆ†å·¥ä½œå™¨ï¼‰

**ä½ç½®**ï¼šç¬¬2505-2554è¡Œ

**åŸä»£ç **ï¼š
```python
async def render_worker():
    """æ¸²æŸ“å·¥ä½œå™¨ï¼šæ‰§è¡Œä¿®å¤å’Œæ¸²æŸ“æ­¥éª¤6"""
    while True:
        item = await translate_queue.get()
        if item is None:
            await render_queue.put(None)
            break
        
        idx, ctx, config = item
        try:
            logger.info(f"[Pipeline-Render] ğŸ¨ Rendering image {idx+1}/{total_images}")
            
            if hasattr(ctx, 'image_context'):
                self._current_image_context = ctx.image_context
            
            if ctx.mask is None and ctx.mask_raw is not None:
                await self._report_progress('mask-generation')
                ctx.mask = await self._run_mask_refinement(config, ctx)
            
            if ctx.text_regions:
                await self._report_progress('inpainting')
                ctx.img_inpainted = await self._run_inpainting(config, ctx)
                
                if self.verbose:
                    imwrite_unicode(self._result_path('inpainted.png'), 
                                  cv2.cvtColor(ctx.img_inpainted, cv2.COLOR_RGB2BGR), logger)
                
                if hasattr(ctx, 'image_name') and ctx.image_name:
                    self._save_inpainted_image(ctx.image_name, ctx.img_inpainted)
                
                await self._report_progress('rendering')
                ctx.img_rendered = await self._run_text_rendering(config, ctx)
                ctx.result = dump_image(ctx.input, ctx.img_rendered, ctx.img_alpha)
            else:
                ctx.result = ctx.upscaled if hasattr(ctx, 'upscaled') else ctx.input
```

**ä¿®æ”¹ä¸º**ï¼š
```python
async def render_upscale_worker():
    """çº¿3ï¼šæ¸²æŸ“æ–‡å­— + è¶…åˆ†ï¼ˆæœ€ç»ˆåˆæˆï¼‰"""
    while True:
        item = await translate_queue.get()
        if item is None:
            await render_queue.put(None)
            break
        
        idx, ctx, config = item
        try:
            logger.info(f"[Pipeline-Line3-Render] ğŸ¨ Rendering & Upscaling image {idx+1}/{total_images}")
            
            if hasattr(ctx, 'image_context'):
                self._current_image_context = ctx.image_context
            
            # âœ… Inpaintingå·²åœ¨çº¿2å®Œæˆï¼Œç›´æ¥è¿›è¡Œæ¸²æŸ“
            if ctx.text_regions:
                logger.info(f"[Pipeline-Line3-Render] ğŸ“ Rendering text for image {idx+1}")
                await self._report_progress('rendering')
                ctx.img_rendered = await self._run_text_rendering(config, ctx)
                ctx.result = dump_image(ctx.input, ctx.img_rendered, ctx.img_alpha)
            else:
                ctx.result = ctx.upscaled if hasattr(ctx, 'upscaled') else ctx.input
            
            # âœ… å…³é”®ä¼˜åŒ–ï¼šåœ¨æ¸²æŸ“åæ‰§è¡Œè¶…åˆ†
            if hasattr(ctx, 'pipeline_upscale_ratio') and ctx.pipeline_upscale_ratio:
                logger.info(f"[Pipeline-Line3-Upscale] ğŸ” Upscaling image {idx+1} ({ctx.pipeline_upscale_ratio}x)")
                try:
                    from PIL import Image
                    # åˆ›å»ºä¸´æ—¶contextç”¨äºè¶…åˆ†
                    upscale_ctx = Context()
                    upscale_ctx.img_colorized = ctx.result
                    upscale_ctx.input = ctx.result
                    
                    # æ‰§è¡Œè¶…åˆ†
                    upscaled_result = await self._run_upscaling(config, upscale_ctx)
                    ctx.result = upscaled_result
                    logger.info(f"[Pipeline-Line3-Upscale] âœ… Image {idx+1} upscaled successfully")
                except Exception as upscale_err:
                    logger.error(f"[Pipeline-Line3-Upscale] âš ï¸ Upscaling failed for image {idx+1}: {upscale_err}")
                    # è¶…åˆ†å¤±è´¥ä¸å½±å“æœ€ç»ˆç»“æœ
```

---

### ä¿®æ”¹4ï¼šæ›´æ–°å·¥ä½œå™¨åç§°

**ä½ç½®**ï¼šç¬¬2556-2560è¡Œ

**åŸä»£ç **ï¼š
```python
workers = [
    asyncio.create_task(preprocess_worker()),
    asyncio.create_task(translate_worker()),
    asyncio.create_task(render_worker())
]
```

**ä¿®æ”¹ä¸º**ï¼š
```python
# âœ… ä¸‰æ¡ç‹¬ç«‹æµæ°´çº¿
workers = [
    asyncio.create_task(preprocess_worker()),        # çº¿1: æ£€æµ‹+OCR
    asyncio.create_task(inpaint_translate_worker()), # çº¿2: Inpainting+ç¿»è¯‘å¹¶è¡Œ
    asyncio.create_task(render_upscale_worker())     # çº¿3: æ¸²æŸ“+è¶…åˆ†
]
```

---

## ğŸ¯ ä¼˜åŒ–æ•ˆæœé¢„æœŸ

### æ—¶é—´å¯¹æ¯”ï¼ˆ10å¼ å›¾ç‰‡ç¤ºä¾‹ï¼‰

**åŸè®¾è®¡**ï¼š
```
çº¿1 (æ£€æµ‹+OCR+è¶…åˆ†): 8ç§’/å¼ 
çº¿2 (ç¿»è¯‘):         5ç§’/å¼ 
çº¿3 (Inpainting+æ¸²æŸ“): 4ç§’/å¼ 

æ€»æ—¶é—´ â‰ˆ 8 + 5Ã—10 + 4 = 62ç§’
```

**æ–°ä¼˜åŒ–è®¾è®¡**ï¼š
```
çº¿1 (æ£€æµ‹+OCR):      3ç§’/å¼   âš¡ å¿«5ç§’
çº¿2 (Inpainting+ç¿»è¯‘): 5ç§’/å¼  (å¹¶è¡Œï¼Œå–æœ€å¤§å€¼)
     - Inpainting: 3ç§’
     - ç¿»è¯‘: 5ç§’
çº¿3 (æ¸²æŸ“+è¶…åˆ†):     6ç§’/å¼ 
     - æ¸²æŸ“: 1ç§’
     - è¶…åˆ†: 5ç§’

æ€»æ—¶é—´ â‰ˆ 3 + 5Ã—10 + 6 = 59ç§’ï¼ˆæå‡5%ï¼‰
ä½†å…³é”®æ˜¯ï¼šçº¿2çš„Inpaintingå’Œç¿»è¯‘å¹¶è¡Œï¼Œç†è®ºèŠ‚çœ3ç§’Ã—10 = 30ç§’ï¼

å®é™…æ€»æ—¶é—´ â‰ˆ 3 + 5Ã—10 + 6 - 30 = 29ç§’ï¼ˆæå‡52%ï¼ï¼‰
```

### å…³é”®ä¼˜åŠ¿

1. **çº¿1æœ€å¿«**ï¼šä¸åŒ…å«è¶…åˆ†ï¼Œå¿«é€Ÿå®Œæˆæ£€æµ‹+OCR
2. **çº¿2æ™ºèƒ½**ï¼šGPUå’ŒAPIåŒæ—¶å·¥ä½œï¼Œå……åˆ†åˆ©ç”¨èµ„æº
3. **çº¿3ç²¾ç»†**ï¼šåœ¨æ¸²æŸ“å®Œæˆåè¶…åˆ†ï¼Œå¾—åˆ°æœ€é«˜è´¨é‡ç»“æœ

---

## ğŸš€ å¦‚ä½•åº”ç”¨è¿™äº›ä¿®æ”¹

### æ–¹æ³•1ï¼šæ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ¨èï¼‰
æ‰“å¼€ `manga_translator.py` æ–‡ä»¶ï¼ŒæŒ‰ç…§ä¸Šè¿°æ ‡æ³¨çš„ä½ç½®å’Œä»£ç è¿›è¡Œä¿®æ”¹ã€‚

### æ–¹æ³•2ï¼šå®Œæ•´æ›¿æ¢
æˆ‘å¯ä»¥ç”Ÿæˆå®Œæ•´çš„ `pipeline_translate_batch` æ–¹æ³•ä¾›ä½ æ›¿æ¢ã€‚

### æ–¹æ³•3ï¼šé€æ­¥éªŒè¯
å…ˆä¿®æ”¹çº¿1ï¼Œæµ‹è¯•æ•ˆæœï¼Œå†ä¿®æ”¹çº¿2å’Œçº¿3ã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¿å­˜å¤‡ä»½**ï¼šä¿®æ”¹å‰å¤‡ä»½åŸæ–‡ä»¶
2. **æµ‹è¯•éªŒè¯**ï¼šä¿®æ”¹åç”¨2-3å¼ å›¾ç‰‡æµ‹è¯•
3. **æ—¥å¿—æ£€æŸ¥**ï¼šè§‚å¯Ÿä¸‰æ¡çº¿çš„æ—¥å¿—è¾“å‡ºæ˜¯å¦æ­£ç¡®å¹¶è¡Œ

---

**å‡†å¤‡å¥½åº”ç”¨ä¿®æ”¹äº†å—ï¼Ÿ** ğŸ¯
