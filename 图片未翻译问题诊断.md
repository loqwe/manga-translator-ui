# 图片未翻译问题诊断指南

## 📊 问题现象

**症状**：部分图片（如001、002、003、016、017）没有被翻译

**日志特征**：
```
Line1: 完成处理图片 1/17，检测到 X 个文本区域
Line2: 开始批量翻译 3 个项目
No post-translation replacements made.  ← 直接出现，没有翻译API调用
Line2: 完成批量翻译 3 个项目
```

## 🔍 诊断步骤

### v2.5 新增调试日志

现在运行翻译时，会输出以下详细信息：

#### 1. Line1文本过滤诊断

**合并前后对比**：
```
Line1: 图片 1 文本合并后无区域（合并前有5个文本行），跳过后续处理
```
这说明：OCR识别到5个文本行，但在合并阶段**全部被过滤**了。

**文本区域详情**（debug级别）：
```
Line1: 图片1 - region0: '你好'
Line1: 图片1 - region1: '世界'
```

#### 2. Line2批量翻译诊断

**提取文本统计**：
```
Line2: 批次共提取到 0 个文本待翻译  ← 关键！
```

**每个图片的详情**（debug级别）：
```
Line2: 图片1 - text_regions数量: 0
Line2: 图片2 - text_regions数量: 3
Line2: 图片2 - region0: 'Hello'
Line2: 图片2 - region1: 'World'
```

**警告信息**：
```
Line2: 批次中没有文本需要翻译！图片索引: [0, 1, 2]
```

## ❌ 可能的原因

### 原因1：文本被判定为"无价值"

**触发条件**：
```python
is_valuable_text(region.text) == False
```

**常见无价值文本**：
- `...` `．．．` `……`
- 单个标点符号：`。` `！` `？` `,`
- 纯数字：`123`
- 纯空格或空字符串

**解决方案**：
如果这些文本确实需要翻译，需要调整`is_valuable_text`函数的判断逻辑。

### 原因2：文本长度太短

**触发条件**：
```python
len(region.text) < config.ocr.min_text_length
```

**日志提示**：
```
Filtered out: 你
Reason: Text length is less than the minimum required length.
```

**解决方案**：
在UI中调整"最小文本长度"参数（`config.ocr.min_text_length`），将其设置为1。

### 原因3：源语言和目标语言相同

**触发条件**：
```python
langcodes.tag_distance(region.source_lang, config.translator.target_lang) == 0
```

**日志提示**：
```
Filtered out: 你好
Reason: Text language matches the target language and no_text_lang_skip is False.
```

**解决方案**：
- 检查目标语言设置是否正确
- 或启用`no_text_lang_skip`选项

## 🔧 启用详细日志

### 方法1：命令行参数
```bash
--verbose
```

### 方法2：修改日志级别
在代码中设置：
```python
import logging
logging.getLogger('manga_translator').setLevel(logging.DEBUG)
```

## 📋 诊断检查清单

运行翻译后，检查日志：

- [ ] **Line1警告**：是否有"文本合并后无区域"的警告？
  - 如果有，说明文本被过滤了
  - 查看"合并前有X个文本行"，确认OCR识别到了文本

- [ ] **过滤原因**：查找"Filtered out"日志
  - 记录被过滤的文本内容
  - 记录过滤原因（Reason:）

- [ ] **Line2统计**：查找"批次共提取到 X 个文本待翻译"
  - 如果是0，说明批次中所有图片的文本都被过滤了

- [ ] **Line2警告**：是否有"批次中没有文本需要翻译"？
  - 如果有，列出了哪些图片索引

## ✅ 验证修复

修改配置后，重新运行翻译，应该看到：

```
Line2: 批次共提取到 6 个文本待翻译  ← 不再是0
Context-aware translation enabled...  ← 翻译API被调用
No post-translation replacements made.
Line2: 完成批量翻译 3 个项目
```

---

**版本**: v2.5  
**更新日期**: 2025-11-15  
**状态**: 已添加详细诊断日志
