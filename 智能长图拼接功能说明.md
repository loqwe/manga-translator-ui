# 智能长图拼接功能说明

## ✨ 功能概述

智能长图拼接功能可以将连续的漫画图片自动拼接成长图，避免在翻译过程中切断跨页对话气泡，提升翻译上下文的连贯性。

## 🎯 主要特性

### 1. **智能边界检测**
- 自动检测图片边界的文字气泡
- 避免在气泡中间进行分段
- 保护跨页对话的完整性

### 2. **灵活的分段策略**
- 可配置最大长图高度（默认10000px）
- 自动寻找安全的分段点
- 优先选择无气泡的边界位置

### 3. **无缝集成**
- 与四线流水线完全兼容
- 可随时开启/关闭
- 失败时自动回退到正常处理

## ⚙️ 配置参数

在 `config-example.json` 的 `cli` 部分添加以下配置：

```json
{
  "cli": {
    "enable_long_image_stitching": false,    // 是否启用长图拼接
    "long_image_max_height": 10000,           // 单个长图段的最大高度（像素）
    "long_image_bubble_margin": 100           // 边界气泡检测范围（像素）
  }
}
```

### 参数说明

- **enable_long_image_stitching**: 
  - `false` (默认): 禁用长图拼接
  - `true`: 启用长图拼接
  
- **long_image_max_height**: 
  - 默认值: `10000` 像素
  - 建议范围: `8000-15000` 像素
  - 说明: 单个长图段的最大高度，超过此高度会自动分段
  
- **long_image_bubble_margin**: 
  - 默认值: `100` 像素
  - 建议范围: `50-200` 像素
  - 说明: 在图片边界上下各检测的范围，用于发现跨页气泡

## 📋 使用流程

### 1. 启用功能

编辑配置文件，将 `enable_long_image_stitching` 设置为 `true`：

```json
"enable_long_image_stitching": true
```

### 2. 运行翻译

正常运行翻译任务即可，系统会自动：
1. 分析连续图片
2. 检测边界气泡
3. 智能拼接图片
4. 进行翻译处理

### 3. 查看日志

运行时会输出详细的拼接日志：

```
[长图拼接] 启用智能长图拼接功能
[长图拼接] 配置: 最大高度=10000px, 边界检测=100px
[长图拼接] 开始处理 46 张图片
[长图拼接] 完成: 46张原始图片 → 17个长图段
[长图拼接] 准备段1/17: 3张图, 高度6375px
```

## 🔍 工作原理

### 分段算法

1. **初始化**: 从第一张图片开始累积
2. **高度检查**: 每添加一张图片，检查累积高度
3. **边界检测**: 如果即将超过最大高度，检测当前边界
4. **安全点搜索**:
   - 优先级1: 无气泡的边界（最安全）
   - 优先级2: 单侧有气泡的边界
   - 优先级3: 双侧有气泡但气泡小的边界
5. **分段执行**: 在最佳安全点进行分段

### 气泡检测

使用 OpenCV 进行边界区域的气泡检测：
- 灰度化处理
- 二值化（阈值200）
- 轮廓检测
- 面积过滤（>200px²）

### 评分系统

每个潜在分段点都会获得一个安全评分：
- **0分**: 无气泡（最安全）
- **1分**: 单侧有气泡
- **2分**: 双侧有气泡
- **3分**: 强制分段点（仅在没有更好选择时使用）

## 🧪 测试功能

运行测试脚本验证拼接功能：

```bash
python test_image_stitcher.py
```

测试内容包括：
1. 基础拼接功能
2. 边界检测准确性
3. 分段策略有效性

## ⚠️ 注意事项

### 1. 内存使用
- 长图会占用更多内存
- 建议将 `long_image_max_height` 控制在15000以内
- 处理高分辨率图片时注意内存限制

### 2. 适用场景
- ✅ 推荐: 连续的漫画页面
- ✅ 推荐: 有跨页对话的内容
- ❌ 不推荐: 独立的单页图片
- ❌ 不推荐: 已经是长图的内容

### 3. 兼容性
- 需要启用 `pipeline_mode: true`
- 与所有翻译器兼容
- 与检测器、OCR、渲染器兼容

### 4. 失败处理
如果拼接失败，系统会：
1. 记录错误日志
2. 自动回退到正常流水线处理
3. 继续完成翻译任务

## 📊 性能影响

### 优势
- ✅ 提升翻译上下文连贯性
- ✅ 避免跨页对话气泡被切断
- ✅ 减少OCR和翻译次数

### 开销
- ⚡ 额外的边界检测时间（<1秒/张）
- ⚡ 图片拼接时间（<0.5秒/段）
- ⚡ 略微增加内存使用

总体来说，对于有跨页对话的漫画，启用长图拼接功能可以显著提升翻译质量。

## 🛠️ 高级配置示例

### 高质量翻译场景
```json
{
  "enable_long_image_stitching": true,
  "long_image_max_height": 12000,
  "long_image_bubble_margin": 150
}
```

### 快速处理场景
```json
{
  "enable_long_image_stitching": true,
  "long_image_max_height": 8000,
  "long_image_bubble_margin": 80
}
```

### 低内存场景
```json
{
  "enable_long_image_stitching": true,
  "long_image_max_height": 6000,
  "long_image_bubble_margin": 50
}
```

## 📝 更新日志

### v1.0.0 (2025-11-17)
- ✨ 初始版本
- ✅ 实现智能边界检测
- ✅ 实现分段策略
- ✅ 集成到流水线模式

---

**提示**: 如果遇到问题，请检查日志文件中的 `[长图拼接]` 相关输出。
